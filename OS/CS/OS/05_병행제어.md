# 05. ë³‘í–‰ ì œì–´

## ë°ì´í„°ì˜ ì ‘ê·¼

![image-20220210205831883](05_ë³‘í–‰ì œì–´.assets/image-20220210205831883.png)

## Race Condition

![image-20220210210632275](05_ë³‘í–‰ì œì–´.assets/image-20220210210632275.png)

* Race Condition(ê²½ìŸìƒíƒœ) : í•˜ë‚˜ì˜ ê³µìœ  ë°ì´í„°ì— ë™ì‹œì— ì ‘ê·¼í•˜ê²Œ ë˜ì—ˆì„ ë•Œ ìƒê¸°ëŠ” ë¬¸ì œ

* ì„œë¡œ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ë“¤ë¼ë¦¬ëŠ” CPU ê°¯ìˆ˜ì— ìƒê´€ì—†ì´ race condition ë¬¸ì œë˜ì§€ ì•ŠëŠ”ë‹¤.
* race conditionì€ CPU ê°€ í•˜ë‚˜ì—¬ë„ ë¬¸ì œê°€  ë  ìˆ˜ ìˆë‹¤.
  * ex) í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ê°€ ì‹œìŠ¤í…œ ì½œì„ í•˜ì—¬ ìš´ì˜ì²´ì œê°€ ì»¤ë„ì˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì¤‘ ë‹¤ë¥¸ ì‚¬ìš©ì í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹œìŠ¤í…œ ì½œì´ ë“¤ì–´ì™€ ì‘ì—… ì¤‘ì´ë˜ ì»¤ë„ì˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒ

### OSì—ì„œ race condition ë°œìƒí•˜ëŠ” ê²½ìš°

* kernel ìˆ˜í–‰ ì¤‘ ì¸í„°ëŸ½íŠ¸ ë°œìƒ ì‹œ

  ![image-20220210213210172](05_ë³‘í–‰ì œì–´.assets/image-20220210213210172.png)

  

* Process ê°€ system call ì„ í•˜ì—¬ kernel mode ë¡œ ìˆ˜í–‰ ì¤‘ì¸ë° context switchê°€ ì¼ì–´ë‚˜ëŠ” ê²½ìš°

  ![image-20220210211633929](05_ë³‘í–‰ì œì–´.assets/image-20220210211633929.png)

  ![image-20220210211740809](05_ë³‘í–‰ì œì–´.assets/image-20220210211740809.png)

* Multiprocessor ì—ì„œ shared memory ë‚´ì˜ kernel data

  ![image-20220210213810405](05_ë³‘í–‰ì œì–´.assets/image-20220210213810405.png)

## Process Synchronization ë¬¸ì œ

* ê³µìœ ë°ì´í„°(shared data)ì˜ ë™ì‹œ ì ‘ê·¼(concurrent access)ì€ ë°ì´í„°ì˜ ë¶ˆì¼ì¹˜ ë¬¸ì œ (inconsistency)ë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.
* ì¼ê´€ì„±(consistency)ìœ ì§€ë¥¼ ìœ„í•´ì„œëŠ” í˜‘ë ¥ í”„ë¡œì„¸ìŠ¤(cooperating process)ê°„ì˜ ì‹¤í–‰ ìˆœì„œ(orderly execution)ë¥¼ ì •í•´ì£¼ëŠ” ë§¤ì»¤ë‹ˆì¦˜ í•„ìš”

```
ğŸ’¡ Race Condition
* ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ë“¤ì´ ë™ì‹œì— ê³µìœ  ë°ì´í„°ë¥¼ ì ‘ê·¼í•˜ëŠ” ìƒí™©
* ë°ì´í„°ì˜ ìµœì¢… ì—°ì‚° ê²°ê³¼ëŠ” ë§ˆì§€ë§‰ì— ê·¸ ë°ì´í„°ë¥¼ ë‹¤ë£¬ í”„ë¡œì„¸ìŠ¤ì— ë”°ë¼ ë‹¬ë¼ì§
```

> race condition ì„ ë§‰ê¸° ìœ„í•´ì„œëŠ” concurrent process ëŠ” ë™ê¸°í™”(synchronize) ë˜ì–´ì•¼ í•œë‹¤.

* race condition ì˜ ì˜ˆì‹œ

![image-20220210214709971](05_ë³‘í–‰ì œì–´.assets/image-20220210214709971.png)

![image-20220210214924565](05_ë³‘í–‰ì œì–´.assets/image-20220210214924565.png)

* P1ì´ critical section ì— ë“¤ì–´ê°€ë©´, P2ëŠ” critical section ì— ë“¤ì–´ê°€ì§€ ëª»í•˜ë„ë¡(lock) ë§‰ì•„ì•¼í•œë‹¤.

  ![image-20220210215030329](05_ë³‘í–‰ì œì–´.assets/image-20220210215030329.png)

## í”„ë¡œê·¸ë¨ì  í•´ê²°ë²•ì˜ ì¶©ì¡± ì¡°ê±´

![image-20220210220500483](05_ë³‘í–‰ì œì–´.assets/image-20220210220500483.png)

* Mutual Exclusion (ìƒí˜¸ ë°°ì œ)
* Progress (ì§„í–‰)
* Bounded Waiting (ìœ í•œëŒ€ê¸°)

## Algorithm 1

![image-20220210215718151](05_ë³‘í–‰ì œì–´.assets/image-20220210215718151.png)

- ë™ì‹œì— ì•ˆë“¤ì–´ê°€ê²Œ ë³´ì¥. í•œ í”„ë¡œì„¸ìŠ¤ê°€ ë¬´í•œíˆ ëŒ€ê¸°í•˜ëŠ” ë¬¸ì œ ë°œìƒ

## Algorithm 2

![image-20220210220754673](05_ë³‘í–‰ì œì–´.assets/image-20220210220754673.png)

* ë‘ í”„ë¡œì„¸ìŠ¤ê°€ ê³„ì† ì–‘ë³´í•˜ëŠ” ìƒí™© ë°œìƒ

## Algorithm 3 (Peterson's Algorithm)

![image-20220210221327272](05_ë³‘í–‰ì œì–´.assets/image-20220210221327272.png)

* ì„ê³„ì˜ì—­ ë“¤ì–´ê°€ê¸° ì „ì— trunì„ ìƒëŒ€ ì°¨ë¡€ë¡œ ì„¤ì •, flagê³¼ turn ë‘˜ ë‹¤ ê²€ì‚¬
* ë¬¸ì œì  : Busy Waiting (=spin lock)
  * ë‚´ê°€ critical section ì— ëª»ë“¤ì–´ê°€ëŠ” ìƒí™©. whileë¬¸ ëŒë©´ì„œ ê³„ì† CPU ì™€ memory ë¥¼ ë‚­ë¹„í•¨

```text
ğŸ’¡ ì •ë¦¬
turn : ê³µìœ ìì›ì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ê³  í‘œí˜„í•˜ê¸° ìœ„í•œ ë³€ìˆ˜
flag : ëˆ„êµ¬ì˜ ì°¨ë¡€ì¸ì§€ ëª…ì‹œí•´ì£¼ëŠ” ë³€ìˆ˜
1. turn ë§Œ ì‚¬ìš©
2. flag ë§Œ ì‚¬ìš©
3. turn ê³¼ flag ë‘˜ ë‹¤ ì‚¬ìš©
```

![image-20220215003825296](05_ë³‘í–‰ì œì–´.assets/image-20220215003825296.png)

## Synchronization hardware

![image-20220210222117911](05_ë³‘í–‰ì œì–´.assets/image-20220210222117911.png)

* race condition ìƒê¸°ëŠ” ì´ìœ ëŠ”  CPU ì—ì„œ ë©”ëª¨ë¦¬ ì½ì–´ì™€ì„œ ê°’ ë³€ê²½í•˜ì—¬ ì €ì¥í•˜ëŠ” ê³¼ì •ì´ atomicí•˜ê²Œ ì´ë£¨ì–´ì§€ì§€ ì•Šì•„ì„œì´ë‹¤. hardwareì—ì„œ atomic í•˜ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤ë©´ race condition ë¬¸ì œ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.
* atomic : ì¤‘ë‹¨ë˜ê±°ë‚˜ ë¶„í• ë  ìˆ˜ ì—†ëŠ” ì›ìì  ëª…ë ¹ì–´

## Semaphores

* ì¼ì¢…ì˜ ì¶”ìƒ ìë£Œí˜•

![image-20220210230541254](05_ë³‘í–‰ì œì–´.assets/image-20220210230541254.png)

* P(S) : së¥¼ ê°ì†Œ, ê³µìœ ë°ì´í„°ë¥¼ íšë“í•˜ëŠ” ê³¼ì •
* V(s) : së¥¼ ì¦ê°€, ê³µìœ ë°ì´í„°ë¥¼ ë°˜ë‚©í•˜ëŠ” ê³¼ì •
* busy waiting (=spin lock) ì—ëŠ” íš¨ìœ¨ì ì´ì§€ ëª»í•¨
  * -> Block & Wakeup (=sleep lock) ë°©ì‹ì˜ êµ¬í˜„

![image-20220210233431602](05_ë³‘í–‰ì œì–´.assets/image-20220210233431602.png)

* mutex(mutual exclusion) : í•˜ë‚˜ë§Œ critical sectionì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆë‹¤

### Block/Wakeup Implementation

![image-20220210234012248](05_ë³‘í–‰ì œì–´.assets/image-20220210234012248.png)

![image-20220210234048490](05_ë³‘í–‰ì œì–´.assets/image-20220210234048490.png)

* P(S) ì—°ì‚° í›„ S.value ê°€ ìŒìˆ˜ì´ë©´ block(sleep) ìƒíƒœ
  * (= P ì—°ì‚° ë¶ˆê°€ëŠ¥í•˜ë©´ í”„ë¡œì„¸ìŠ¤ ìì²´ë¥¼ ì ë“¤ê²Œ í•¨)

* V(S) ì—°ì‚°ì„ í†µí•´ S.valueê°€ ì–‘ìˆ˜ê°€ ë˜ì–´ì•¼ë§Œ ì„ê³„ì˜ì—­ ë“¤ì–´ê°ˆ ìˆ˜ ìˆë‹¤.

![image-20220210234604461](05_ë³‘í–‰ì œì–´.assets/image-20220210234604461.png)

* ì¼ë°˜ì ìœ¼ë¡œ Block/Wakeup ì´ í›¨ì”¬ ì¢‹ë‹¤.
  * Critical section ì˜ ê¸¸ì´ê°€ ê¸¸ë©´ Block/Wakeup ì´ ì ë‹¹
  * Critical section ì˜ ê¸¸ì´ê°€ ë§¤ìš° ì§§ìœ¼ë©´ busy-wait ê°€ ë” íš¨ê³¼ì ì¼ ìˆ˜ë„ ìˆë‹¤.
* Critical section ê²½ìŸì´ ì¹˜ì—´í•˜ë©´ -> Block/Wakeup

### Semaphores ì˜ íƒ€ì…

* Counting semaphore
  *  ë„ë©”ì¸ì´ 0 ì´ìƒì¸ ì„ì˜ì˜ ì •ìˆ˜ê°’
  * ì£¼ë¡œ resource counting ì— ì‚¬ìš©
* Binary semaphore (=mutex)
  * 0 ë˜ëŠ” 1 ê°’ë§Œ ê°€ì§ˆìˆ˜ ìˆëŠ” ì„¸ë§ˆí¬ì–´
  * ì£¼ë¡œ mutual exclusion (lock/unlock) ì— ì‚¬ìš©

### Deadlock and Starvation

![image-20220215231814206](05_ë³‘í–‰ì œì–´.assets/image-20220215231814206.png)

* Deadlock
  1. P0 ì´ S íšë“, P1ì´ Që¥¼ íšë“
  2. P0 ì´ Q íšë“í•˜ë ¤ê³  ë³´ë‹ˆê¹Œ P1ì´ ê°€ì§€ê³ ìˆìŒ. P1ì´ S íšë“í•˜ë ¤ê³  ë³´ë‹ˆê¹Œ P0ê°€ ê°€ì§€ê³ ìˆìŒ
* (=Starvation)
  * ê° í”„ë¡œì„¸ìŠ¤ ì…ì¥ì—ì„œ ë³´ë©´ Starvation ìƒíƒœ
* í•´ê²°ë°©ë²•?
  * P0ê³¼ P1ì´ ë‘˜ë‹¤ S ë¨¼ì € íšë“í•˜ë„ë¡ P1ì˜ ìˆœì„œ ë°”ê¾¸ë©´ Deadlock ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

### Classial Problems of Synchronization

#### Bounded-Buffer Problem

![image-20220215232309603](05_ë³‘í–‰ì œì–´.assets/image-20220215232309603.png)

* Produser process
  * ìƒì‚°ì í”„ë¡œì„¸ìŠ¤ëŠ” ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ì„œ ê³µìœ ë²„í¼ì— ì§‘ì–´ë„£ëŠ” ì—­í• 
* Consumer process
  * ì†Œë¹„ì í”„ë¡œì„¸ìŠ¤ëŠ” ë°ì´í„°ë¥¼ êº¼ë‚´ê°€ëŠ” ì—­í• 
* í•´ê²° ë°©ë²•
  * ê³µìœ  ë²„í¼ì— lock ì„ ê±¸ê³  í‘¸ëŠ” ë™ì‘ì´ í•„ìš”
  * counting semaphoreë¥¼ ì´ìš©í•˜ì—¬ ë‚¨ì€ ë²„í¼ì˜ ê°¯ìˆ˜ë¥¼ ì„¸ê³ , binary semaphoreë¥¼ ì´ìš©í•˜ì—¬ ê³µìœ ë²„í¼ì˜ lock ì„ ê±¸ê³  í‘¸ëŠ” ë™ì‘ì„ í•œë‹¤.

![image-20220215234828996](05_ë³‘í–‰ì œì–´.assets/image-20220215234828996.png)

* Producer
  * ë¹ˆ ë²„í¼ë¥¼ ì–»ê³ 
  * ë½ì„ ê±¸ê³  ë²„í¼ì— ì¶”ê°€í•˜ê³  ë½ì„ í‘¼ë‹¤.
  * ë‚´ìš©ì´ ë“¤ì–´ìˆëŠ” ë²„í¼ ë°˜í™˜
* Consumer
  * ë‚´ìš©ì´ ë“¤ì–´ìˆëŠ” ë²„í¼ íšë“
  * ë½ì„ ê±¸ê³  ë²„í¼ì— ë‚´ìš©ì„ êº¼ë‚´ê°€ê³  ë½ì„ í‘¼ë‹¤.
  * ë¹ˆ ë²„í¼ë¥¼ ë°˜í™˜

#### Readers-Writers Problem

![image-20220215235227521](05_ë³‘í–‰ì œì–´.assets/image-20220215235227521.png)

* ì½ê¸° ì“°ê¸°ëŠ” ì£¼ë¡œ DBìª½ì—ì„œ ë§ì´ í•˜ê¸° ë•Œë¬¸ì— ê³µìœ ë°ì´í„°ì˜ ì˜ˆì‹œë¥¼ DBë¡œ ë“¤ì—ˆìŒ
* readcount ê°€ ì–‘ìˆ˜ì¸ê²½ìš° : ë‹¤ë¥¸ readerê°€ ì ‘ê·¼ ì¤‘
* readcount ê°€ 0ì¸ ê²½ìš° : ë‹¤ë¥¸ readerê°€ ì ‘ê·¼í•˜ì§€ ì•Šê³ ìˆìŒ
* readcount ë¼ëŠ” ë³€ìˆ˜ë„ ë™ì‹œì ‘ê·¼ì„ ë§‰ê¸°ìœ„í•´ lockì„ ì‚¬ìš©í•¨ -> mutex

![image-20220216001123728](05_ë³‘í–‰ì œì–´.assets/image-20220216001123728.png)

* writerëŠ” dbì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ dbì— lockì„ ê±´ë‹¤.
* readerëŠ” dbë¥¼ ì½ê¸° ìœ„í•´ readcountì— ëŒ€í•œ mutex lockì„ ê±¸ê³  readcountë¥¼ ì¦ê°€ì‹œí‚¤ê³  mutex lockì„ í’€ì–´ì¤€ë‹¤.
  * if readcount == 1 : ìµœì´ˆ ì ‘ê·¼í•˜ëŠ” readerëŠ” dbì— lock ì„ ê±¸ì–´ì„œ writerì˜ ì ‘ê·¼ì„ ë§‰ì•„ì•¼ í•œë‹¤.
  * 1ì´ ì•„ë‹Œ ê²½ìš°ëŠ” í˜„ì¬ dbë¥¼ ì½ê³ ìˆëŠ” readerê°€ ìˆìœ¼ë¯€ë¡œ êµ³ì´ dbì— lockì„ ê±¸ í•„ìš” ì—†ì´ dbì— ì ‘ê·¼í•˜ë©´ ëœë‹¤.
* readerëŠ” dbë¥¼ ë‹¤ ì½ìœ¼ë©´ readcountë¥¼ ê°ì†Œì‹œí‚¨ë‹¤. ë™ì¼í•˜ê²Œ ì „í›„ì— mutex lock ì„ ê±¸ê³ /í•´ì œí•œë‹¤.
  * if readcount == 0 : ë§ˆì§€ë§‰ readerëŠ” dbì— lockì„ í’€ì–´ì„œ writerê°€ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë„ë¡ í•´ì•¼í•œë‹¤.
* starvation ë°œìƒ ê°€ëŠ¥ (ì´ë¡ ì )
  * reader 100ê°œê°€ ë„ì°©í•´ì„œ db lock ì„ ê±¸ê³  dbë¥¼ ì½ê³ ìˆë‹¤. 
  * writerëŠ” dbë¥¼ ì ‘ê·¼í•˜ê¸° ìœ„í•´ ëŒ€ê¸° ì¤‘
  * ë§ˆì§€ë§‰ readerê°€ ì½ê³  ë‚˜ê°€ë ¤ëŠ” ë•Œì— reader 1000ê°œê°€ ë„ì°©í•¨
  * writerëŠ” ë¬´í•œì • ê¸°ë‹¤ë¦¼
  * í•´ê²° ë°©ë²•
    * ì¼ì • ì‹œê°„ ê°„ê²©ì„ ë‘ê³  ê·¸ ì´ë‚´ì— ë„ì°©í•œ readerë“¤ë§Œ ë™ì‹œì ‘ê·¼ì„ í—ˆìš©í•œë‹¤.

#### Dining-Philosophers Problem

![image-20220216004534692](05_ë³‘í–‰ì œì–´.assets/image-20220216004534692.png)

* ë¬¸ì œì  : ë‹¤ì„¯ëª…ì˜ ì² í•™ìê°€ ëª¨ë‘ ì™¼ìª½ ì “ê°€ë½ì„ ì¡ìœ¼ë©´ ì•„ë¬´ë„ ë°¥ì„ ë¨¹ì§€ ëª»í•œë‹¤. -> deadlock

![image-20220216004945233](05_ë³‘í–‰ì œì–´.assets/image-20220216004945233.png)

* ì “ê°€ë½ì„ ë‘ê°œ ëª¨ë‘ ì§‘ì„ ìˆ˜ ìˆì„ ë•Œì—ë§Œ ì “ê°€ë½ì„ ì§‘ì„ ìˆ˜ ìˆê²Œ í•˜ì

![image-20220216010417155](05_ë³‘í–‰ì œì–´.assets/image-20220216010417155.png)

* self[i] == 1 : ì–‘ ìª½ ì “ê°€ë½ì„ ëª¨ë‘ ì¡ì„ ìˆ˜ ìˆëŠ” ìƒíƒœ (default 0)
* mutex : ê³µìœ  ë°ì´í„°ì— ëŒ€í•œ lock/unlock
* state : í¸ì˜ìƒ ìƒíƒœ ì²´í¬
* pickup(i) : ië¼ëŠ” ì² í•™ìê°€ ì “ê°€ë½ì„ ë“¦
  * ìƒíƒœë¥¼ hungry ë¡œ ë°”ê¾¸ê³ ,
  * test(i) : ì “ê°€ë½ì„ ëª¨ë‘ ì¡ì„ ìˆ˜ ìˆëŠ” ìƒíƒœì¸ì§€ í…ŒìŠ¤íŠ¸í•œë‹¤.
    * ì–‘ìª½ ì “ê°€ë½ì„ ëª¨ë‘ ì¡ì„ ìˆ˜ ìˆìœ¼ë©´ stateë¥¼ eating ìœ¼ë¡œ ë°”ê¾¸ê³  **Vì—°ì‚°ì„ í†µí•´ self[i] ë¥¼ 1ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤.**
  * Vì—°ì‚°ì„ í†µí•´ ì “ê°€ë½ ì¡ì„ ìˆ˜ ìˆëŠ” ê¶Œí•œ 1ì„ ì–»ê³ , P ì—°ì‚°ì„ í†µí•´ self ë¥¼ -1 í•˜ê³  ì “ê°€ë½ì„ ì¡ê²Œëœë‹¤.
  * ë§Œì•½ ì–‘ìª½ ì “ê°€ë½ì„ ì¡ì„ ìˆ˜ ì—†ì–´ì„œ Vì—°ì‚°ì„ í•˜ì§€ ëª»í•˜ë©´, **P ì—°ì‚° í•˜ë ¤ê³  í• ë•Œ self[i] ì˜ ìƒíƒœê°€ 0ì´ ë˜ë¯€ë¡œ block ìƒíƒœ(ì ë“  ìƒíƒœ)ê°€ ëœë‹¤.**
* eat() : ë¨¹ëŠ”ë‹¤.
* putdown(i) : ì “ê°€ë½ì„ ë‚´ë ¤ë†“ëŠ”ë‹¤.
  * state ë¥¼ thinkingìœ¼ë¡œ ë°”ê¾¸ê³ 
  * ë‚´ ì™¼ìª½ ì² í•™ìì™€ ì˜¤ë¥¸ìª½ ì² í•™ìì— ëŒ€í•´ testë¥¼ ìˆ˜í–‰í•œë‹¤. (ì “ê°€ë½ ì¡ì„ ê¶Œí•œ íšë“)

```text
ğŸ’¡ ì¼ë°˜ì ì¸ semaphoreì˜ ì“°ì„ì´ ì•„ë‹ˆë¯€ë¡œ ë™ì‘ì— ëŒ€í•œ ì´í•´ë§Œ í•˜ê³  ë„˜ì–´ê°ˆ ê²ƒ
```



## Monitors

![image-20220216011924559](05_ë³‘í–‰ì œì–´.assets/image-20220216011924559.png)

![image-20220216012255799](05_ë³‘í–‰ì œì–´.assets/image-20220216012255799.png)

* ê³µìœ  ë°ì´í„°ë¥¼ ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œ monitor ì•ˆì— ì •ì˜ëœ í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒ
* ê³µìœ  ë°ì´í„°ì— ëŒ€í•œ ë™ì‹œì ‘ê·¼ì„ ëª¨ë‹ˆí„°ê°€ ì±…ì„ì ¸ì£¼ëŠ” ê²ƒ (semaphoreëŠ” ì±…ì„ì ¸ì£¼ì§€ ì•ŠìŒ)

![image-20220216012447347](05_ë³‘í–‰ì œì–´.assets/image-20220216012447347.png)

* ê³µìœ  ë°ì´í„°ë¥¼ ëª¨ë‹ˆí„° ì•ˆì— ì •ì˜í•˜ê³ , ê³µìœ  ë°ì´í„°ë¥¼ ì ‘ê·¼í•˜ëŠ” ì½”ë“œëŠ” ëª¨ë‹ˆí„° ì•ˆì˜ ì—°ì‚°ìœ¼ë¡œë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œí•¨
* í”„ë¡œì„¸ìŠ¤ê°€ ê³µìœ ë°ì´í„° ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œëŠ” ëª¨ë‹ˆí„°ì˜ ì½”ë“œ ì‚¬ìš©
* ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ì ‘ê·¼í•˜ëŠ” ê²½ìš°, entry queueë¥¼ í†µí•´ ì§„ì… ìì²´ë¥¼ ë§‰ì•„ ë™ê¸°í™” ë¬¸ì œë¥¼ í•´ê²°

![image-20220216012703538](05_ë³‘í–‰ì œì–´.assets/image-20220216012703538.png)

* condition variable : ìì›ì˜ ì—¬ë¶„ì´ ìˆì„ ë•Œë§Œ ìˆ˜í–‰, ê·¸ë ‡ì§€ ì•Šì€ê²½ìš° blocked 
  * blocked queueì˜ ì—­í•  (queueì— ì¤„ì„¸ìš°ê¸°)

### Bounded-Buffer Problem (Monitor)

![image-20220216013047922](05_ë³‘í–‰ì œì–´.assets/image-20220216013047922.png)

* buffer[N] : Monitor ì•ˆì˜ ê³µìœ ë°ì´í„°

* ëª¨ë‹ˆí„°ëŠ” lockì„ ê±¸ê±°ë‚˜ í‘¸ëŠ” ì½”ë“œê°€ ì—†ìŒ (í”„ë¡œê·¸ë˜ë¨¸ ì…ì¥ì—ì„œ í¸ë¦¬)
* produce()
  * ë¹ˆ ë²„í¼ê°€ ìˆìœ¼ë©´ add data
  * ë¹ˆ ë²„í¼ê°€ ì—†ìœ¼ë©´ empty.wait() -> ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ëª¨ë‹ˆí„°ì—ì„œ í™œì„±í™” ë  ìˆ˜ ìˆê²Œ í•¨
  * full.signal() ì„ í†µí•´ ë‚´ìš©ì´ ìˆë‹¤ëŠ” ì‹œê·¸ë„ì„ ë³´ëƒ„
* consume()
  * ë²„í¼ê°€ ì—†ëŠ” ê²½ìš° full.wait()
  * ë‚´ìš©ì´ ë“  ë²„í¼ë¥¼ í•˜ë‚˜ êº¼ë‚´ì„œ ë¹ˆ ë²„í¼ê°€ ìƒê¸°ê²Œ í•¨
  * empty.signal() ì„ í†µí•´ ë¹ˆ ë²„í¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” produceë¥¼ ê¹¨ì›€

```text
ğŸ’¡ ì„¸ë§ˆí¬ì–´ëŠ” ì›ìì ìœ¼ë¡œ ì„¸ë§ˆí¬ì–´ì— ëŒ€í•œ +1,-1ì—°ì‚°ì„ ì§€ì›, ëª¨ë‹ˆí„°ëŠ” ì•„ì˜ˆ ë™ì‹œì ‘ê·¼ì„ ë§‰ì•„ì£¼ëŠ” ì—­í• ì„ í•œë‹¤ëŠ” ì°¨ì´ê°€ ìˆìŒ
```

### Dining Philosophers (Monitor)

![image-20220216014144254](05_ë³‘í–‰ì œì–´.assets/image-20220216014144254.png)

* ì “ê°€ë½ì„ ì¡ëŠ” ì½”ë“œê°€ ëª¨ë‹ˆí„° ì•ˆì˜ ì½”ë“œë¡œë§Œ ì‹¤í–‰ë˜ë„ë¡ í•¨
* self[5] : ì “ê°€ë½ì„ ì¡ì„ ìˆ˜ ìˆëŠ”ì§€?
* pickup(i)
  * ìƒíƒœë¥¼ hungry ë¡œ ë°”ê¾¸ê³ 
  * ì “ê°€ë½ ë‘ê°œë¥¼ ë‹¤ ì¡ì„ ìˆ˜ ìˆëŠ”ì§€ í…ŒìŠ¤íŠ¸
  * í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ì„œ ì “ê°€ë½ì„ ì¡ì•˜ìœ¼ë©´ (state==eating) ë¨¹ìœ¼ë©´ ëœë‹¤. -> eat()
  * ëª»ë¨¹ìœ¼ë©´ self[i].wait() - queueì— ì¤„ì„œì„œ blocked
* test(i)
  * ì “ê°€ë½ì„ ì¡ì„ ìˆ˜ ìˆìœ¼ë©´ ìƒíƒœë¥¼ eatingìœ¼ë¡œ ë°”ê¾¸ê³ 
  * (ì ë“¤ì–´ ìˆì„ ìˆ˜ ìˆëŠ”) ì² í•™ìë¥¼ ê¹¨ì›Œì£¼ê¸° ìœ„í•´ self[i].signal()

* putdown(i)
  * ìƒíƒœë¥¼ thinking ìœ¼ë¡œ ë°”ê¾¸ê³ 
  * ì¸ì ‘ ì² í•™ìë“¤ì— ëŒ€í•´ test ë¥¼ ìˆ˜í–‰í•œë‹¤. -> ì¸ì ‘ ì² í•™ìë¥¼ ê¹¨ì›€

## êµì°©ìƒíƒœ (Deadlock)

![image-20220216015308568](05_ë³‘í–‰ì œì–´.assets/image-20220216015308568.png)

![image-20220216015604479](05_ë³‘í–‰ì œì–´.assets/image-20220216015604479.png)

* P0 ëŠ” Aë¥¼ ì–»ê³  Bë¥¼ ê¸°ë‹¤ë¦¼, P1ëŠ” Bë¥¼ ì–»ê³  Aë¥¼ ê¸°ë‹¤ë¦¼
* í”„ë¡œì„¸ìŠ¤ê°€ ìì›ì„ ì‚¬ìš©í•˜ëŠ” ì ˆì°¨
  * ìš”ì²­
  * í• ë‹¹
  * ì‚¬ìš©
  * í•´ì œ

> ğŸ’¡ ìš´ì˜ì²´ì œ ìƒì‹ìœ¼ë¡œ ìì£¼ ë‚˜ì˜¤ëŠ” ë¬¸ì œ : Deadlockì˜ ë°œìƒ 4ê°€ì§€ ì¡°ê±´

* ë‹¤ìŒ 4ê°€ì§€ ì¡°ê±´ì„ ëª¨ë‘ ë§Œì¡±í•´ì•¼ deadlockì´ ë°œìƒí•œë‹¤.

![image-20220216015854678](05_ë³‘í–‰ì œì–´.assets/image-20220216015854678.png)

### ìì›í• ë‹¹ ê·¸ë˜í”„

* í”„ë¡œì„¸ìŠ¤ì™€ ìì›ì˜ ê´€ê³„ë¥¼ ê·¸ë˜í”„ë¡œ í‘œí˜„
* R -> P : ìì› Rì„ í”„ë¡œì„¸ìŠ¤ P ê°€ ì ìœ í•˜ê³  ìˆë‹¤.
* P -> R : í”„ë¡œì„¸ìŠ¤ Pê°€ ìì› Rì„ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤.

![image-20220216160302084](05_ë³‘í–‰ì œì–´.assets/image-20220216160302084.png)

![image-20220216160609652](05_ë³‘í–‰ì œì–´.assets/image-20220216160609652.png)

* ê·¸ë˜í”„ì— ì‚¬ì´í´ì´ ì—†ìœ¼ë©´ deadlock ì´ ì•„ë‹ˆë‹¤.
* ê·¸ë˜í”„ì— ì‚¬ì´í´ì´ ìˆìœ¼ë©´
  * ìì›ì´ 1ê°œë°–ì— ì—†ëŠ” ê²½ìš° deadlock
  * ìì›ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—¬ëŸ¬ê°œì¸ ê²½ìš° deadlockì´ ì•„ë‹ ìˆ˜ë„ ìˆë‹¤.

### Deadlockì˜ ì²˜ë¦¬ ë°©ë²•

![image-20220216161000412](05_ë³‘í–‰ì œì–´.assets/image-20220216161000412.png)

* ì˜ˆë°©
  * Deadlock Prevention
  * Deadlock Avoidance
* recover
  * Deadlock Detection and recovery
* ì•„ë¬´ê²ƒë„ ì•ˆí•¨
  * Deadlock Ignorance

#### Deadlock Prevention

![image-20220216161115690](05_ë³‘í–‰ì œì–´.assets/image-20220216161115690.png)

#### Deadlock Avoidance

![image-20220216162122037](05_ë³‘í–‰ì œì–´.assets/image-20220216162122037.png)



![image-20220216162228975](05_ë³‘í–‰ì œì–´.assets/image-20220216162228975.png)